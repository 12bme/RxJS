(function(t){var e={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},n=e[typeof window]&&window||this,r=e[typeof exports]&&exports&&!exports.nodeType&&exports,o=e[typeof module]&&module&&!module.nodeType&&module,i=(o&&o.exports===r&&r,e[typeof global]&&global);!i||i.global!==i&&i.window!==i||(n=i),"function"==typeof define&&define.amd?define(["rx","exports"],function(e,r){return n.Rx=t(n,r,e),n.Rx}):"object"==typeof module&&module&&module.exports===r?module.exports=t(n,module.exports,require("./rx")):n.Rx=t(n,{},n.Rx)}).call(this,function(t,e,n,r){function o(t,e){return 1===t.length&&Array.isArray(t[e])?t[e]:w.call(t)}function i(t){this.patterns=t}function s(t,e){this.expression=t,this.selector=e}function u(t,e,n){var r=t.get(e);if(!r){var o=new E(e,n);return t.set(e,o),o}return r}function c(t,e,n){this.joinObserverArray=t,this.onNext=e,this.onCompleted=n,this.joinObservers=new g;for(var r=0,o=this.joinObserverArray.length;o>r;r++){var i=this.joinObserverArray[r];this.joinObservers.set(i,i)}}var a=n.Observable,l=a.prototype,h=n.AnonymousObservable,f=a.throwException,p=n.Observer.create,d=n.SingleAssignmentDisposable,v=n.CompositeDisposable,b=n.internals.AbstractObserver,m=n.helpers.noop,y=(n.internals.isEqual,n.internals.inherits),w=(n.internals.Enumerable,n.internals.Enumerator,n.iterator,n.doneEnumerator,Array.prototype.slice),g=t.Map||function(){function t(){this._keys=[],this._values=[]}return t.prototype.get=function(t){var e=this._keys.indexOf(t);return-1!==e?this._values[e]:r},t.prototype.set=function(t,e){var n=this._keys.indexOf(t);-1!==n&&(this._values[n]=e),this._values[this._keys.push(t)-1]=e},t.prototype.forEach=function(t,e){for(var n=0,r=this._keys.length;r>n;n++)t.call(e,this._values[n],this._keys[n])},t}();i.prototype.and=function(t){return new i(this.patterns.concat(t))},i.prototype.thenDo=function(t){return new s(this,t)},s.prototype.activate=function(t,e,n){for(var o=this,i=[],s=0,a=this.expression.patterns.length;a>s;s++)i.push(u(t,this.expression.patterns[s],e.onError.bind(e)));var l=new c(i,function(){var t;try{t=o.selector.apply(o,arguments)}catch(n){return e.onError(n),r}e.onNext(t)},function(){for(var t=0,e=i.length;e>t;t++)i[t].removeActivePlan(l);n(l)});for(s=0,a=i.length;a>s;s++)i[s].addActivePlan(l);return l},c.prototype.dequeue=function(){this.joinObservers.forEach(function(t){t.queue.shift()})},c.prototype.match=function(){var t,e,n=!0;for(t=0,e=this.joinObserverArray.length;e>t;t++)if(0===this.joinObserverArray[t].queue.length){n=!1;break}if(n){var r=[],o=!1;for(t=0,e=this.joinObserverArray.length;e>t;t++)r.push(this.joinObserverArray[t].queue[0]),"C"===this.joinObserverArray[t].queue[0].kind&&(o=!0);if(o)this.onCompleted();else{this.dequeue();var i=[];for(t=0,e=r.length;r.length>t;t++)i.push(r[t].value);this.onNext.apply(this,i)}}};var E=function(t){function e(e,n){t.call(this),this.source=e,this.onError=n,this.queue=[],this.activePlans=[],this.subscription=new d,this.isDisposed=!1}y(e,t);var n=e.prototype;return n.next=function(t){if(!this.isDisposed){if("E"===t.kind)return this.onError(t.exception),r;this.queue.push(t);for(var e=this.activePlans.slice(0),n=0,o=e.length;o>n;n++)e[n].match()}},n.error=m,n.completed=m,n.addActivePlan=function(t){this.activePlans.push(t)},n.subscribe=function(){this.subscription.setDisposable(this.source.materialize().subscribe(this))},n.removeActivePlan=function(t){this.activePlans.splice(this.activePlans.indexOf(t),1),0===this.activePlans.length&&this.dispose()},n.dispose=function(){t.prototype.dispose.call(this),this.isDisposed||(this.isDisposed=!0,this.subscription.dispose())},e}(b);return l.and=function(t){return new i([this,t])},l.thenDo=function(t){return new i([this]).thenDo(t)},a.when=function(){var t=o(arguments,0);return new h(function(e){var n=[],r=new g,o=p(e.onNext.bind(e),function(t){r.forEach(function(e){e.onError(t)}),e.onError(t)},e.onCompleted.bind(e));try{for(var i=0,s=t.length;s>i;i++)n.push(t[i].activate(r,o,function(t){var r=n.indexOf(t);n.splice(r,1),0===n.length&&e.onCompleted()}))}catch(u){f(u).subscribe(e)}var c=new v;return r.forEach(function(t){t.subscribe(),c.add(t)}),c})},n});